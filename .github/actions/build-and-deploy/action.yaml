name: Build and Deploy
inputs:
  project:
    description: "Project folder under ./projects containing values.yaml"
    required: false
    default: ''
  suffix:
    description: "Optional suffix appended to the ephemeral folder name"
    required: false
    default: ''
  backend-dir:
    description: "Path to backend Dockerfile"
    required: false
    default: ./app
  frontend-dir:
    description: "Path to frontend Dockerfile"
    required: false
    default: ./frontend
  ensure-dirs:
    description: "Create backend and frontend directories if they don't exist"
    required: false
    default: "false"
runs:
  using: composite
  steps:
    - name: Checkout to ephemeral workspace
      uses: johnhojohn969/setup-ephemeral-action/.github/actions/checkout@main
      with:
        suffix: ${{ inputs.suffix }}
    - name: Ensure backend and frontend directories exist
      if: inputs.ensure-dirs == 'true'
      shell: bash
      run: |
        mkdir -p "${{ inputs.backend-dir }}" "${{ inputs.frontend-dir }}"
    - name: Build and Push Images
      uses: johnhojohn969/setup-ephemeral-action/.github/actions/build-and-push@main
      with:
        backend-dir: ${{ inputs.backend-dir }}
        frontend-dir: ${{ inputs.frontend-dir }}
    - name: Determine project name
      id: vars
      shell: bash
      run: |
        if [ -n "${{ inputs.project }}" ]; then
          echo "name=${{ inputs.project }}" >> "$GITHUB_OUTPUT"
        else
          echo "name=$(basename ${{ github.repository }})" >> "$GITHUB_OUTPUT"
        fi
    - name: Deploy with Helm
      uses: johnhojohn969/setup-ephemeral-action/.github/actions/deploy-helm-generic@main
      with:
        project: ${{ steps.vars.outputs.name }}
